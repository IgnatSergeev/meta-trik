#!/bin/sh


VIDEO0=/dev/video0
VIDEO1=/dev/video1

case $1 in  
  0|$VIDEO0)
    BUS=0x1
    VIDEO_PATH=$VIDEO0
    echo 0 > /sys/class/gpio/gpio109/value
    usleep 10000
    echo 1 > /sys/class/gpio/gpio109/value
    ;;
  1|$VIDEO1)
    BUS=0x2
    VIDEO_PATH=$VIDEO1
    echo 0 > /sys/class/gpio/gpio33/value
    usleep 10000
    echo 1 > /sys/class/gpio/gpio33/value
    ;;
  *)
    USAGE_TEXT="Inits ov7670. Usage:\n\t 1, $VIDEO1 \n\t 0, $VIDEO0\n"
    printf "$USAGE_TEXT"
    exit 1
    ;;
esac

cam () {
  i2cset -y $BUS 0x21 $1 $2 || exit $?
}


# Resets all registers to default values
cam 0x12 0x80
#sleep 1
cam 0x12 0x00

cam 0x3d 0xD9

#CCIR656 enable
cam 0x04 0x40

# Output range: [01] to [FE]
cam 0x40 0x80

#Some magic TODO: comments
cam 0x17 0x13
cam 0x18 0x01
cam 0x32 0x80
cam 0x19 0x02
cam 0x1a 0x7a
cam 0x03 0x0a
# set QVGA according to
# Table 2-2. (but without input clock divider
# and without SCALING_PCLK_DELAY)
# OV7670/OV7171 CMOS VGA (640x480) CameraChip��™
# Implementation Guide
#cam 0x12 0 # YUV
cam 0x0c 0x04
cam 0x3e 0x19
#cam 0x70 0x3A
#cam 0x71 0x35
cam 0x72 0x11
cam 0x73 0xf1
# this was set to 2 in the guide, but it makes
# image width less that 320. Setting this to 0
# helps but may spoil left/right boundary of
# the video
#cam 0xa2 0x00

# make the original window (before downsampling)
# 6 pixels wider in order to reach 320 pixel width
# at the output. Use reg 0x32 for that
#cam 0x3a 0x8
##cam 0x17 0x11
##cam 0x18 0x61
#cam 0x32  0xb0  # 0xb0 = 0x80 + (6 << 3)


#cam 0x14 0x0a # max gain is 2x
cam 0x7a 0x20;    cam 0x7b 0x10
cam 0x7c 0x1e;    cam 0x7d 0x35
cam 0x7e 0x5a;    cam 0x7f 0x69
cam 0x80 0x76;    cam 0x81 0x80
cam 0x82 0x88;    cam 0x83 0x8f
cam 0x84 0x96;    cam 0x85 0xa3
cam 0x86 0xaf;    cam 0x87 0xc4
cam 0x88 0xd7;    cam 0x89 0xe8

cam 0xb0 0x84 #change green/purple stuff on true colors
# Output sequence 01: Y V Y U,
# Sensor automatically sets output window when
# resolution changes.
cam 0x3a 0x09

# output drive 1x  // 4x
cam 0x09 0x00

#not so bright
# Automatic Gain Ceiling 4x
cam 0x14 0x1a

#turn on all stuff (awb/agc/aec)
cam 0x13 0x87

#simple AWB
cam 0x6f 0x6f

#pretty agc/aec
cam 0xa5 0x05
cam 0x24 0x95
cam 0x25 0x33
cam 0x26 0xe3
cam 0x9f 0x78 
cam 0xa0 0x68 
cam 0xa6 0xd8 
cam 0xa7 0xd8 
cam 0xa9 0x90 
cam 0xaa 0x94 

#banding filter
cam 0x9d 0x98
cam 0x9e 0x7f
cam 0xa5 0x02
cam 0xab 0x03
cam 0x3b 0x12

#yuv
cam 0x4f 0x0C
cam 0x50 0x34
cam 0x51 0x40
cam 0x52 0x40
cam 0x53 0x29
cam 0x54 0x17
cam 0x58 0xB3 # 9e

#cam 0x20 0x0f //darker sharper

v4l2-ctl -d $VIDEO_PATH -s pal 1 > /dev/null
echo "ov7670 successfully initialised" 
